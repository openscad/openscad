version: 2
jobs:
  openscad-macos:
    macos:
      xcode: "10.1.0"
    steps:
      - checkout
      - run:
          name: Build OpenSCAD MacOS
          no_output_timeout: 18000
          command: |
              system_profiler SPSoftwareDataType
              mkdir /tmp/out
              CI_BASEDIR=$(pwd)
              ( cd /tmp && curl -s -O https://files.openscad.org/circleci/macports.tar.bz2 ) || true
              sudo tar xj -C / -f /tmp/macports.tar.bz2 || true
              if [ -f /opt/local/bin/port ]; then
                  export PATH=/opt/local/bin:/opt/local/sbin:$PATH
                  source setenv_mac.sh
                  ./scripts/macosx-build-dependencies.sh double_conversion
                  ./scripts/macosx-build-dependencies.sh eigen
                  ./scripts/macosx-build-dependencies.sh gmp
                  ./scripts/macosx-build-dependencies.sh mpfr
                  ./scripts/macosx-build-dependencies.sh glew
                  ./scripts/macosx-build-dependencies.sh gettext
                  tar cjv /tmp/out/libraries.tar.bz2 "$CI_BASEDIR/../libraries"
              else
                  curl -s -O https://distfiles.macports.org/MacPorts/MacPorts-2.5.4.tar.bz2
                  tar xjf MacPorts-2.5.4.tar.bz2
                  cd MacPorts-2.5.4
                  ./configure
                  make
                  sudo make install
                  source ~/.profile
                  sudo port -v selfupdate
                  export COLUMNS=80
                  sudo port install cmake
                  sudo port install curl
                  sudo port install pkgconfig
                  tar cjf /tmp/out/macports.tar.bz2 /opt/local
              fi
      - store_artifacts:
          path: /tmp/out
          destination: build

workflows:
  version: 2
  build:
    jobs:
      - openscad-macos:
          filters:
              branches:
                  ignore:
                      - coverity_scan
                      - /^(?i:continuous)$/
