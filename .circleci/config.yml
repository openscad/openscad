version: 2
jobs:
  openscad-macos:
    macos:
      xcode: "10.1.0"
    steps:
      - checkout
      - run:
          name: Build OpenSCAD MacOS
          no_output_timeout: 18000
          command: |
              system_profiler SPSoftwareDataType
              CI_BASEDIR=/Users/distiller/project
              CI_LIBRARYDIR=/Users/distiller/libraries/install
              mkdir /tmp/out
              mkdir -p "$CI_LIBRARYDIR"
              ( cd /tmp && curl -s -O https://files.openscad.org/circleci/macports.tar.bz2 ) || true
              ( cd /tmp && curl -s -O https://files.openscad.org/circleci/libraries.tar.bz2 ) || true
              sudo tar xj -C / -f /tmp/macports.tar.bz2 || true
              tar xj -C "$CI_LIBRARYDIR" -f /tmp/libraries.tar.bz2 || true
              if [ -f /opt/local/bin/port ]; then
                  export PATH=/opt/local/bin:/opt/local/sbin:$PATH
                  source setenv_mac.sh
                  ./scripts/macosx-build-dependencies.sh double_conversion
                  ./scripts/macosx-build-dependencies.sh eigen
                  ./scripts/macosx-build-dependencies.sh gmp
                  ./scripts/macosx-build-dependencies.sh mpfr
                  ./scripts/macosx-build-dependencies.sh glew
                  ./scripts/macosx-build-dependencies.sh gettext
                  ./scripts/macosx-build-dependencies.sh libffi
                  ./scripts/macosx-build-dependencies.sh freetype
                  ./scripts/macosx-build-dependencies.sh ragel
                  ./scripts/macosx-build-dependencies.sh harfbuzz
                  ./scripts/macosx-build-dependencies.sh libzip
                  ./scripts/macosx-build-dependencies.sh libxml2
                  #./scripts/macosx-build-dependencies.sh fontconfig
                  #./scripts/macosx-build-dependencies.sh hidapi
                  ./scripts/macosx-build-dependencies.sh libuuid
                  #./scripts/macosx-build-dependencies.sh lib3mf
                  ./scripts/macosx-build-dependencies.sh glib2
                  ./scripts/macosx-build-dependencies.sh boost
                  ./scripts/macosx-build-dependencies.sh cgal
                  ./scripts/macosx-build-dependencies.sh qt5
                  ./scripts/macosx-build-dependencies.sh opencsg
                  ./scripts/macosx-build-dependencies.sh qscintilla
                  #./scripts/macosx-build-dependencies.sh -d sparkle
                  tar cj -C "$CI_LIBRARYDIR" -f /tmp/out/libraries.tar.bz2 .
              else
                  curl -s -O https://distfiles.macports.org/MacPorts/MacPorts-2.5.4.tar.bz2
                  tar xjf MacPorts-2.5.4.tar.bz2
                  cd MacPorts-2.5.4
                  ./configure
                  make
                  sudo make install
                  source ~/.profile
                  sudo port -v selfupdate
                  export COLUMNS=80
                  sudo port install cmake
                  sudo port install curl
                  sudo port install pkgconfig
                  tar cjf /tmp/out/macports.tar.bz2 /opt/local
              fi
      - store_artifacts:
          path: /tmp/out
          destination: build

workflows:
  version: 2
  build:
    jobs:
      - openscad-macos:
          filters:
              branches:
                  only:
                      - master
                      - circleci-macos

