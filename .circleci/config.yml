version: 2.1

orbs:
  macos: circleci/macos@2.5.1

executors:
  mxe-executor:
    docker:
      - image: openscad/mxe-x86_64-gui:latest
    resource_class: large
  appimage-executor:
    docker:
      - image: openscad/appimage-x86_64-base:latest
    resource_class: large
  wasm-executor:
    docker:
      - image: openscad/wasm-base-release:latest
    resource_class: large
  macos-executor:
    resource_class: m4pro.medium
    macos:
      xcode: 26.1
  python-executor:
    docker:
      - image: cimg/python:3.14

commands:
  # Provides OPENSCAD_VERSION and OPENSCAD_COMMIT
  establish_version:
    parameters:
      build_id:
        type: string
        default: ""
    steps:
      - run:
          name: Establish Version
          command: |
              source scripts/establish_version.sh
              OPENSCAD_COMMIT=$(openscad_commit)
              BASE_VERSION=$(openscad_version)
              if [ -n "<< parameters.build_id >>" ]; then
                  OPENSCAD_VERSION="${BASE_VERSION}.<< parameters.build_id >>"
              else
                  OPENSCAD_VERSION="${BASE_VERSION}"
              fi
              
              echo "export OPENSCAD_COMMIT=$OPENSCAD_COMMIT" >> $BASH_ENV
              echo "export OPENSCAD_VERSION=$OPENSCAD_VERSION" >> $BASH_ENV
  get_source:
    parameters:
      method:
        type: string
        default: git
    steps:
      - when:
          condition:
            equal: [ git, << parameters.method >> ]
          steps:
            - checkout
            - run: git submodule update --init --recursive
      - when:
          condition:
            not:
              equal: [ git, << parameters.method >> ]
          steps:
            - attach_workspace:
                at: /tmp/workspace
            - run:
                name: "Unpack tarball"
                command: tar -xzf /tmp/workspace/openscad-*.tar.gz --strip-components=1
  setup-sccache:
    steps:
      - run:
          name: Install sccache
          command: |
              SCCACHE_VERSION=0.12.0
              SCCACHE_TGZ="sccache-v${SCCACHE_VERSION}-x86_64-unknown-linux-musl.tar.gz"
              curl -fsSL -o "/tmp/${SCCACHE_TGZ}" \
                "https://github.com/mozilla/sccache/releases/download/v${SCCACHE_VERSION}/${SCCACHE_TGZ}"
              tar -xzf "/tmp/${SCCACHE_TGZ}" -C /tmp
              install -m 0755 "/tmp/sccache-v${SCCACHE_VERSION}-x86_64-unknown-linux-musl/sccache" /usr/local/bin/sccache
  restore-sccache-cache:
    steps:
      - restore_cache:
          name: Restore sccache cache
          key: sccache-cache-stable-{{ arch }}-{{ .Environment.CIRCLE_JOB }}
  save-sccache-cache:
    steps:
      - save_cache:
          name: Save sccache cache
          # We use {{ epoch }} to always upload a fresh cache:
          # Of course, restore_cache will not find this exact key,
          # but it will fall back to the closest key (aka the most recent).
          # See https://discuss.circleci.com/t/add-mechanism-to-update-existing-cache-key/9014/13
          key: sccache-cache-stable-{{ arch }}-{{ .Environment.CIRCLE_JOB }}-{{ epoch }}
          paths:
            - "~/.cache/sccache"

jobs:
  openscad-mxe:
    executor: mxe-executor
    parameters:
      openscad_platform:
        type: string
        default: windows
      openscad_build_type:
        type: string
        default: snapshot
      source_method:
        type: string
        default: git
    steps:
      - get_source:
          method: << parameters.source_method >>
      - setup-sccache
      - restore-sccache-cache
      - establish_version:
          build_id: "ci${CIRCLE_BUILD_NUM}"
      - run:
          name: Build OpenSCAD Windows Application (64bit)
          no_output_timeout: 18000
          command: |
              sccache --start-server
              export NUMCPU=4
              export LC_ALL=C.UTF-8
              export MXEDIR=/mxe
              export PKG_CONFIG_PATH=/mxe/usr/x86_64-w64-mingw32.static.posix/lib/pkgconfig
              export USE_SCCACHE=1
              ln -sf /usr/bin/python{3,}
              if [ x"${CIRCLE_BRANCH}" = xmaster ] || [ "<< parameters.openscad_build_type >>" != "snapshot" ]; then
                export SUFFIX=""
              else 
                export SUFFIX="_$(echo ${CIRCLE_BRANCH} | sed -e 's,pull/,PR,; s,/head,h,; s,/merge,m,; s,/,.,g')"
              fi
              
              ./scripts/release-common.sh mingw64 -v "$OPENSCAD_VERSION" -c "$OPENSCAD_COMMIT" << parameters.openscad_build_type >>
              sccache --show-stats
              mkdir -p /tmp/artifacts
              for f in mingw*/*.zip mingw*/*.exe; do N=$(basename "$f" | sed -e "s/\\(-x86-[36][24]\\)/\\1${SUFFIX}/;"); cp -iv "$f" /tmp/artifacts/"$N"; done
              if [ -n "${CODE_SIGNING_KEY}" ]
              then
                  cd /tmp/artifacts
                  echo $CODE_SIGNING_DATA | base64 -d | gzip -d | gpg --import --allow-secret-key-import --pinentry-mode loopback --passphrase-file <(echo $CODE_SIGNING_PW)
                  export GPG_ARGS="--batch --yes --passphrase-fd 0 --pinentry-mode loopback --detach-sign --armor"
                  for a in *.exe *.zip; do echo "$CODE_SIGNING_PW" | gpg -u "$CODE_SIGNING_KEY" $GPG_ARGS "$a"; sha256sum "$a" | tee "${a}.sha256"; sha512sum "$a" | tee "${a}.sha512"; done
                  rm -rf ~/.gnupg
              else
                  echo "Skipping code signing."
              fi
      - save-sccache-cache
      - store_artifacts:
          path: /tmp/artifacts
          destination: MXE
  openscad-appimage:
    executor: appimage-executor
    parameters:
      openscad_platform:
        type: string
        default: linux-appimage
      openscad_build_type:
        type: string
        default: snapshot
      source_method:
        type: string
        default: git
    steps:
      - get_source:
          method: << parameters.source_method >>
      - setup-sccache
      - restore-sccache-cache
      - establish_version:
          build_id: "ai"
      - run:
          name: Build OpenSCAD AppImage
          no_output_timeout: 18000
          command: |
              sccache --start-server
              if [ x"${CIRCLE_BRANCH}" = xmaster ] || [ "<< parameters.openscad_build_type >>" != "snapshot" ]; then
                export SUFFIX=""
              else
                export SUFFIX="_$(echo ${CIRCLE_BRANCH} | sed -e 's,pull/,PR,; s,/head,h,; s,/merge,m,; s,/,.,g')"
              fi
              if [ "<< parameters.openscad_build_type >>" == "snapshot" ]; then
                export CMAKE_EXTRA_ARGS="-DSNAPSHOT=ON -DEXPERIMENTAL=ON"
              fi
              mkdir build && cd build
              cmake .. \
                  -DOPENSCAD_VERSION="$OPENSCAD_VERSION" \
                  -DOPENSCAD_COMMIT="$OPENSCAD_COMMIT" \
                  -DCMAKE_INSTALL_PREFIX=/usr \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DCMAKE_C_COMPILER_LAUNCHER=sccache \
                  -DCMAKE_CXX_COMPILER_LAUNCHER=sccache \
                  -DUSE_BUILTIN_OPENCSG=ON \
                  -DMANIFOLD_PYBIND=OFF \
                  -DMANIFOLD_TEST=OFF \
                  -DENABLE_PYTHON=ON \
                  -DENABLE_TESTS=OFF \
                  $CMAKE_EXTRA_ARGS
              cmake --build . -j 2  # using all 4 cores OOMs
              DESTDIR=../AppDir cmake --install .
              cd ..
              export PATH=/appimage/usr/bin:"$PATH"
              export EXTRA_QT_PLUGINS=svg
              export PYTHON_VERSION=$(python3 -c "import sys; v=sys.version_info; print(f'{v.major}.{v.minor}.{v.micro}')")
              export LINUXDEPLOY_OUTPUT_VERSION="${OPENSCAD_VERSION}${SUFFIX}"
              linuxdeploy --plugin python --plugin qt --output appimage --appdir AppDir
              sccache --show-stats
              mkdir -p /tmp/artifacts
              cp -iv OpenSCAD-*.AppImage /tmp/artifacts
              if [ -n "${CODE_SIGNING_KEY}" ]; then
                  cd /tmp/artifacts
                  echo $CODE_SIGNING_DATA | base64 -d | gzip -d | gpg --import --allow-secret-key-import --pinentry-mode loopback --passphrase-file <(echo $CODE_SIGNING_PW)
                  export GPG_ARGS="--batch --yes --passphrase-fd 0 --pinentry-mode loopback --detach-sign --armor"
                  for a in *.AppImage; do echo "$CODE_SIGNING_PW" | gpg -u "$CODE_SIGNING_KEY" $GPG_ARGS "$a"; sha256sum "$a" | tee "${a}.sha256"; sha512sum "$a" | tee "${a}.sha512"; done
                  rm -rf ~/.gnupg
              else
                  echo "Skipping code signing."
              fi
      - save-sccache-cache
      - store_artifacts:
          path: /tmp/artifacts
          destination: AppImage
  openscad-wasm:
    executor: wasm-executor
    parameters:
      openscad_platform:
        type: string
        default: ""
      openscad_build_type:
        type: string
        default: snapshot
      source_method:
        type: string
        default: git
    steps:
      - get_source:
          method: << parameters.source_method >>
      - setup-sccache
      - restore-sccache-cache
      - run:
          name: Install latest node.js
          command: |
              npm i -g n
              n latest
      - when:
          condition:
            equal: [ wasm-web, << parameters.openscad_platform >> ]
          steps:
            - run:
                name: Install Puppeteer
                command: |
                    apt-get update
                    apt-get install -y \
                        libatk1.0-0 libatk-bridge2.0-0 libdrm2 libxcomposite1 libxdamage1 \
                        libxfixes3 libxrandr2 libgbm1 libxkbcommon0 libpango-1.0-0 libcairo2
                    export PATH="/usr/local/bin:$PATH"
                    npm init -y
                    npm i puppeteer
                    npx puppeteer browsers install chrome
      - establish_version:
          build_id: "wasm"
      - run:
          name: Build OpenSCAD WASM (<< parameters.openscad_platform >>)
          no_output_timeout: 18000
          command: |
              sccache --start-server
              export WASM_TYPE=$(echo "<< parameters.openscad_platform >>" | sed 's/^wasm-//')
              if [ x"${CIRCLE_BRANCH}" = xmaster ] || [ "<< parameters.openscad_build_type >>" != "snapshot" ]; then
                export SUFFIX=""
              else 
                export SUFFIX="_$(echo ${CIRCLE_BRANCH} | sed -e 's,pull/,PR,; s,/head,h,; s,/merge,m,; s,/,.,g')"
              fi
              if [ "<< parameters.openscad_build_type >>" == "snapshot" ]; then
                export CMAKE_EXTRA_ARGS="-DSNAPSHOT=ON -DEXPERIMENTAL=ON"
              fi
              emcmake cmake -G Ninja -B ../build . \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DCMAKE_C_COMPILER_LAUNCHER=sccache \
                  -DCMAKE_CXX_COMPILER_LAUNCHER=sccache \
                  -DWASM_BUILD_TYPE=$WASM_TYPE \
                  -DOPENSCAD_COMMIT="$OPENSCAD_COMMIT" \
                  -DOPENSCAD_VERSION="$OPENSCAD_VERSION" \
                  $CMAKE_EXTRA_ARGS
              cd ../build
              cmake --build .
              sccache --show-stats
              mkdir -p /tmp/artifacts
              zip -9r "/tmp/artifacts/OpenSCAD-${OPENSCAD_VERSION}${SUFFIX}-WebAssembly-$WASM_TYPE.zip" openscad.*
              if [ -n "${CODE_SIGNING_KEY}" ]; then
                  cd /tmp/artifacts
                  echo $CODE_SIGNING_DATA | base64 -d | gzip -d | gpg --import --allow-secret-key-import --pinentry-mode loopback --passphrase-file <(echo $CODE_SIGNING_PW)
                  export GPG_ARGS="--batch --yes --passphrase-fd 0 --pinentry-mode loopback --detach-sign --armor"
                  for a in *.zip; do echo "$CODE_SIGNING_PW" | gpg -u "$CODE_SIGNING_KEY" $GPG_ARGS "$a"; sha256sum "$a" | tee "${a}.sha256"; sha512sum "$a" | tee "${a}.sha512"; done
                  rm -rf ~/.gnupg
              else
                  echo "Skipping code signing."
              fi
      - save-sccache-cache
      - run:
          name: Verify OpenSCAD WASM build
          command: |
              export WASM_TYPE=$(echo "<< parameters.openscad_platform >>" | sed 's/^wasm-//')
              # node in the path (from emsdk) is too old to run the wasm build, use the one installed by n.
              export PATH="/usr/local/bin:$PATH"
              ./tests/wasm-check.sh $WASM_TYPE
      - store_artifacts:
          path: /tmp/artifacts
          destination: wasm
  openscad-macos:
    executor: macos-executor
    parameters:
      openscad_platform:
        type: string
        default: macos
      openscad_build_type:
        type: string
        default: snapshot
      source_method:
        type: string
        default: git
    steps:
      - macos/install-rosetta
      - get_source:
          method: << parameters.source_method >>
      - run:
          name: Set environment variables
          command: |
            echo "export OPENSCAD_LIBRARIES=$HOME/libraries/install" >> $BASH_ENV
            echo "export PKG_CONFIG_PATH=$HOME/libraries/install/lib/pkgconfig" >> $BASH_ENV
            echo "export DYLD_LIBRARY_PATH=$HOME/libraries/install/lib" >> $BASH_ENV
            echo "export DYLD_FRAMEWORK_PATH=$HOME/libraries/install/lib" >> $BASH_ENV
      - run:
          name: System Info
          command: |
            system_profiler SPHardwareDataType SPSoftwareDataType SPStorageDataType SPDeveloperToolsDataType
      - run:
          name: Install Homebrew packages
          command: |
            brew analytics off
            brew tap
            brew uninstall -f --cask temurin17
            brew update
            brew install automake libtool cmake pkg-config wget meson python-packaging
      - restore_cache:
          keys:
            # CircleCI library caching. If we ever need invalidate the cache (e.g. to remove any old files 
            # from a library cache), the safest, change the MACOS_CACHE_VERSION variable to a random value at
            # https://app.circleci.com/settings/project/github/openscad/openscad/environment-variables.
            - macos-libraries-{{ .Environment.MACOS_CACHE_VERSION }}-{{ checksum "scripts/macosx-build-dependencies.sh" }}-{{ checksum ".circleci/config.yml" }}
            # Fetch the most recently saved cache
            - macos-libraries-{{ .Environment.MACOS_CACHE_VERSION }}-
      - run:
          name: Build Dependencies
          command: |
            # Pick up our own Qt
            export PATH=$OPENSCAD_LIBRARIES/bin:$PATH
            # Build universal binaries and limit to 30 minutes
            ./scripts/macosx-build-dependencies.sh -l 30 -x -a -d
      - run:
          name: Package Dependencies as an artifact
          command: |
            mkdir -p /tmp/artifacts
            tar cz -C "$OPENSCAD_LIBRARIES" -f /tmp/artifacts/libraries.tar.bz2 .
            shasum -a 512 /tmp/artifacts/libraries.tar.bz2 > /tmp/artifacts/libraries.tar.bz2.sha512
      - save_cache:
          # Make sure to create a new cache entry, needed for incremental library builds and also
          # preventing full cache drop after 15 days.
          key: macos-libraries-{{ .Environment.MACOS_CACHE_VERSION }}-{{ checksum "scripts/macosx-build-dependencies.sh" }}-{{ checksum ".circleci/config.yml" }}-{{ .BuildNum }}
          paths:
            - ~/libraries/install
      - establish_version
      - run:
          name: Build OpenSCAD
          command: |
            export NUMCPU=$(($(sysctl -n hw.ncpu) * 3 / 2))
            time ./scripts/release-common.sh -v "$OPENSCAD_VERSION" -c "$OPENSCAD_COMMIT" << parameters.openscad_build_type >>
      - run:
          name: Verify OpenSCAD binary
          command: |
            ./scripts/macosx-sanity-check.py build/OpenSCAD.app/Contents/MacOS/OpenSCAD
      - run:
          name: Sign and Notarize OpenSCAD binary
          command: |
            security -v create-keychain -p "" OpenSCAD.keychain
            security -v list-keychains -s OpenSCAD.keychain
            security -v unlock-keychain -p "" OpenSCAD.keychain
            security -v set-keychain-settings -lt 7200 OpenSCAD.keychain
            echo "$APPLE_CODE_SIGNING_KEY" | base64 -D -o OpenSCAD.p12
            security -v import OpenSCAD.p12 -k OpenSCAD.keychain -f pkcs12 -P "$APPLE_CODE_SIGNING_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
            security -v set-key-partition-list -S apple-tool:,apple: -s -k "" OpenSCAD.keychain
            codesign --options=runtime --keychain OpenSCAD.keychain -s "Marius Kintel" --force --deep build/OpenSCAD.app

            hdiutil create -volname "OpenSCAD" -srcfolder build/OpenSCAD.app -ov -format UDZO "OpenSCAD-$OPENSCAD_VERSION.dmg"  
            codesign --keychain OpenSCAD.keychain -s "Marius Kintel" --force OpenSCAD-$OPENSCAD_VERSION.dmg

            xcrun notarytool submit OpenSCAD-$OPENSCAD_VERSION.dmg --wait --apple-id $APPLE_NOTARIZATION_ACCOUNT --team-id $APPLE_NOTARIZATION_TEAM --password $APPLE_NOTARIZATION_PASSWORD
            # TODO: If notarization fails, we could, download and dump the explanation here.
            xcrun stapler staple OpenSCAD-$OPENSCAD_VERSION.dmg

            security -v delete-keychain OpenSCAD.keychain
            rm OpenSCAD.p12
            cp -R OpenSCAD-$OPENSCAD_VERSION.dmg /tmp/artifacts/
            shasum -a 256 OpenSCAD-$OPENSCAD_VERSION.dmg > OpenSCAD-$OPENSCAD_VERSION.dmg.sha256
            shasum -a 512 OpenSCAD-$OPENSCAD_VERSION.dmg > OpenSCAD-$OPENSCAD_VERSION.dmg.sha512
            cp -v OpenSCAD-$OPENSCAD_VERSION.dmg* /tmp/artifacts/
      - store_artifacts:
          path: /tmp/artifacts
          destination: macOS
  create-tarball:
    executor: python-executor
    parameters:
      openscad_platform:
        type: string
        default: src
      openscad_build_type:
        type: string
        default: release
    steps:
      - checkout
      - run: git submodule update --init --recursive
      - run:
          name: "Extract version"
          command: |
            echo "export OPENSCAD_VERSION=${CIRCLE_TAG#openscad-}" >> $BASH_ENV
            echo "OpenSCAD version: ${CIRCLE_TAG#openscad-}"
      - run:
          name: "Create VERSION.txt file"
          command: |
            echo "$OPENSCAD_VERSION" > VERSION.txt
            cat VERSION.txt
      - run:
          name: "Create COMMIT.txt file"
          command: |
            git log -1 --pretty=format:%h > COMMIT.txt
            cat COMMIT.txt
      - run:
          name: "Install git-archive-all"
          command: pip install git-archive-all
      - run:
          name: "Create source tarball"
          command: |
            mkdir -p /tmp/workspace
            git-archive-all --force-submodules --prefix=openscad-${OPENSCAD_VERSION}/ /tmp/workspace/openscad-${OPENSCAD_VERSION}.tar
            # git-archive-all only archives versioned files. Amending VERSION.txt and COMMIT.txt to the archive
            tar -rf /tmp/workspace/openscad-${OPENSCAD_VERSION}.tar --transform "s|^|openscad-${OPENSCAD_VERSION}/|" VERSION.txt COMMIT.txt
            gzip /tmp/workspace/openscad-${OPENSCAD_VERSION}.tar
            cd /tmp/workspace
            sha256sum openscad-${OPENSCAD_VERSION}.tar.gz > openscad-${OPENSCAD_VERSION}.tar.gz.sha256
            sha512sum openscad-${OPENSCAD_VERSION}.tar.gz > openscad-${OPENSCAD_VERSION}.tar.gz.sha512
            ls -l openscad-${OPENSCAD_VERSION}.*
      - persist_to_workspace:
          root: /tmp/workspace
          paths:
            - openscad-*.tar.gz
            - openscad-*.tar.gz.sha256
            - openscad-*.tar.gz.sha512
      - store_artifacts:
          path: /tmp/workspace
          destination: source-tarball

filters: &release-filters
  tags:
    only: /^openscad-.*$/
  branches:
    ignore: /.*/

workflows:
  version: 2
  "CircleCI snapshot build (master)":
    jobs:
      - openscad-mxe:
          context: secret-context
          filters:
              branches:
                  only:
                      - master
      - openscad-appimage:
          context: secret-context
          filters:
              branches:
                  only:
                      - master
      - openscad-wasm:
          matrix:
            parameters:
              openscad_platform: [wasm-web, wasm-node]
          context: secret-context
          filters:
              branches:
                  only:
                      - master
      - openscad-macos:
          context: secret-context
          filters:
              branches:
                  only:
                      - master
  "CircleCI branch build (PR)":
    jobs:
      - openscad-mxe:
          filters:
              branches:
                  ignore:
                      - master
                      - coverity_scan
                      - /^(?i:continuous)$/
      - openscad-appimage:
          filters:
              branches:
                  ignore:
                      - master
                      - coverity_scan
                      - /^(?i:continuous)$/
      - openscad-wasm:
          matrix:
            parameters:
              openscad_platform: [wasm-web, wasm-node]
          filters:
              branches:
                  ignore:
                      - master
                      - coverity_scan
                      - /^(?i:continuous)$/
      - openscad-macos:
          context: secret-context
          filters:
              branches:
                  only:
                      - /.*-macos/
  "CircleCI release build (tag)":
    jobs:
      - create-tarball:
          filters: *release-filters
      - openscad-macos:
          filters: *release-filters
          openscad_build_type: release
          source_method: tarball
          context: secret-context
          requires:
            - create-tarball
      - openscad-appimage:
          filters: *release-filters
          openscad_build_type: release
          source_method: tarball
          context: secret-context
          requires:
            - create-tarball
      - openscad-mxe:
          filters: *release-filters
          openscad_build_type: release
          source_method: tarball
          context: secret-context
          requires:
            - create-tarball
      - openscad-wasm:
          filters: *release-filters
          matrix:
            parameters:
              openscad_platform: [wasm-web, wasm-node]
          openscad_build_type: release
          source_method: tarball
          context: secret-context
          requires:
            - create-tarball
      # We may want to run a job _after_ all binary builds, e.g.
      # to manage artifact collection, GitHub release creations, or other global tasks.
      # We need, however, to deal with (transient) build failures.
      # - openscad-deploy-release:
      #     filters: *release-filters
      #     context: secret-context
      #     requires:
      #       - openscad-macos
      #       - openscad-appimage
      #       - openscad-mxe
      #       - openscad-wasm
