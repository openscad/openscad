name: openscad-nightly
title: OpenSCAD-Nightly
base: core24
version: "git"
summary: OpenSCAD - Design. Code. Create.
description: >
    OpenSCAD is a software for creating solid 3D CAD models. It is free software and
    available for Mac, Windows, Linux and other UNIX-like OSâ€™es. Unlike most 3D design
    software, the focus is not on the artistic aspects of 3D design but instead on the
    CAD aspects. This might be the application you are looking for when you are planning
    to create 3D designs for machine parts but is probably not what you are looking for
    when you are more interested in creating computer-animated movies. OpenSCAD is not
    an interactive modeller. Instead it is something like a 3D-compiler that reads in
    a script file that describes your object and renders the 3D model from this script
    file. This gives you, the designer, full control over the modelling process and
    enables you to easily change any step in your process or make designs that are
    defined by configurable parameters.

    OpenSCAD provides two primary modelling techniques: Constructive solid geometry
    (aka CSG) as well as extrusion of 2D outlines. We support reading, both 2D outlines
    and 3D object from external design files, in a variety of file formats.

    NOTE: This is the development snapshot, automatically built from the source
    repository.
confinement: strict
icon: resources/icons/openscad-nightly-256.png
license: GPL-3.0
grade: stable
platforms:
  amd64:
  arm64:
  s390x:
  ppc64el:

apps:
  openscad-nightly:
    command: usr/bin/openscad-nightly
    command-chain: [ bin/desktop-launch ]
    plugs: [desktop, desktop-legacy, x11, wayland, opengl, home, audio-playback, pulseaudio, network, removable-media, joystick]
    desktop: usr/share/applications/openscad-nightly.desktop
    environment:
      DISABLE_WAYLAND: 1
      LD_LIBRARY_PATH: $LD_LIBRARY_PATH:$SNAP/usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libproxy

parts:
  cgal:
    source: https://github.com/CGAL/cgal/releases/download/v6.1.1/CGAL-6.1.1-library.tar.xz
    plugin: cmake
    cmake-parameters: [
      "-DCMAKE_BUILD_TYPE=Release",
      "-DCMAKE_INSTALL_PREFIX=/usr",
    ]
    after: [ patches ]
    build-packages:
    - cmake
    - libboost-dev
    - libboost-thread-dev

  lib3mf2:
    source: https://github.com/3MFConsortium/lib3mf/archive/refs/tags/v2.4.1.tar.gz
    plugin: cmake
    cmake-parameters: [
      "-DCMAKE_BUILD_TYPE=RelWithDebInfo",
      "-DCMAKE_INSTALL_PREFIX:PATH=/usr",
      "-DCMAKE_INSTALL_LIBDIR:PATH=/usr/lib",
      "-DLIB3MF_TESTS=OFF",
      "-DUSE_INCLUDED_ZLIB=OFF",
      "-DUSE_INCLUDED_LIBZIP=OFF",
      "-DCMAKE_POLICY_VERSION_MINIMUM=3.5",
    ]

  harfbuzz:
    source: https://github.com/harfbuzz/harfbuzz/releases/download/12.3.2/harfbuzz-12.3.2.tar.xz
    plugin: meson
    build-packages:
      - meson
      - libgraphite2-dev
    meson-parameters: [
      "--prefix=/usr",
      "-Dcpp_args=-fno-exceptions",
      "-Dgraphite2=enabled",
      "-Dgobject=disabled",
      "-Dutilities=disabled",
      "-Dtests=disabled",
      "-Dbenchmark=disabled",
      "-Ddocs=disabled"
    ]

  openscad-nightly:
    source: .
    source-type: git
    build-snaps: [cmake]
    plugin: cmake
    override-build: |
        export CC="clang"
        export CXX="clang++"
        export OPENSCAD_COMMIT="$(GIT_DIR=$SNAPCRAFT_PART_SRC/.git git rev-parse --short HEAD)"
        export OPENSCAD_VERSION="$(GIT_DIR=$SNAPCRAFT_PART_SRC/.git git log -1 --format=%at | xargs -I{} date -d @{} +%Y.%m.%d.snap)"
        cmake ${SNAPCRAFT_PART_SRC} \
            -G 'Unix Makefiles' \
            -DCMAKE_PREFIX_PATH="${SNAPCRAFT_STAGE}/usr" \
            -DOPENSCAD_VERSION="${OPENSCAD_VERSION}" \
            -DOPENSCAD_COMMIT="${OPENSCAD_COMMIT}" \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_BUILTIN_OPENCSG=ON \
            -DMANIFOLD_PYBIND=OFF \
            -DMANIFOLD_TEST=OFF \
            -DENABLE_PYTHON=ON \
            -DENABLE_TESTS=OFF \
            -DEXPERIMENTAL=ON \
            -DSUFFIX=nightly \
            -DSNAPSHOT=ON
        cmake --build .
        cmake --install . --prefix "${SNAPCRAFT_PART_INSTALL}/usr"
    after: [ desktop-qt, cgal, lib3mf2, harfbuzz ]
    stage:
    - -usr/lib/*/libharfbuzz*
    build-packages:
    - git
    - clang
    - qt6-base-dev
    - qt6-multimedia-dev
    - libqt6svg6-dev
    - libqt6opengl6-dev
    - libqt6core5compat6-dev
    - libqscintilla2-qt6-dev
    - libeigen3-dev
    - libglib2.0-dev
    - bison
    - flex
    - libglew-dev
    - libglvnd-dev
    - libgmp-dev
    - libmpfr-dev
    - libcairo2-dev
    - libboost-dev
    - libboost-regex-dev
    - libboost-system-dev
    - libboost-program-options-dev
    - libdouble-conversion-dev
    - python3-dev
    - nettle-dev
    - chrpath
    - gettext
    - pkg-config
    - imagemagick
    - libtbb-dev
    - libzip-dev
    - libgl-dev
    - libxml2-dev
    - libfontconfig1-dev
    stage-packages:
    - qt6-wayland
    - libqt6svg6
    - libqt6opengl6
    - libqt6concurrent6
    - libqt6multimedia6
    - libqt6printsupport6
    - libqt6core5compat6
    - libqt6openglwidgets6t64
    - libqscintilla2-qt6-15
    - libasyncns0
    - libboost-regex1.83.0
    - libboost-system1.83.0
    - libboost-program-options1.83.0
    - libdouble-conversion3
    - libflac12t64
    - libglew2.2
    - libglu1-mesa
    - libglvnd0
    - libopengl0
    - libmpfr6
    - libgmpxx4ldbl
    - libogg0
    - libpulse0
    - libsndfile1
    - libvorbis0a
    - libvorbisenc2
    - libzip4t64
    - libtbb12
    - libatomic1
    - libproxy1v5
    - libpython3.12t64

  desktop-qt:
    source: https://github.com/t4saha/snapcraft-desktop-helpers-Qt6.git
    source-subdir: qt
    plugin: make
    stage:
    - -usr/lib/*/libharfbuzz*
    build-packages:
      - build-essential
      - qt6-base-dev
      - dpkg-dev
    stage-packages:
      - libxkbcommon0
      - dmz-cursor-theme
      - light-themes
      - adwaita-icon-theme
      - shared-mime-info
      - libgdk-pixbuf2.0-0
      - xdg-user-dirs
      - locales-all
      - libqt6gui6
      - libqt6svg6 # for loading icon themes which are svg

  patches:
    source: snap/local/patches
    plugin: dump
    prime:
      - -*
