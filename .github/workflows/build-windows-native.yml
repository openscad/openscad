name: Build Windows Native Package

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Release tag to upload to (leave empty for test build)'
        required: false
        default: ''
      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled'
        required: false
        default: false

jobs:
  build-package:
    runs-on: windows-latest
    name: Windows Native Package (Qt6)
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Configure git (disable line-ending conversion for accurate dirty check)
        shell: bash
        run: |
          git config --global core.autocrlf false
          git config --global core.safecrlf false

      - name: Fetch tags for version detection
        shell: bash
        run: |
          git fetch --unshallow --tags || git fetch --tags
          git describe --tags --always --dirty

      - name: Setup (detached) tmate session if enabled
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 5
        with:
          detached: true

      - name: Calculate PACBOY_PACKAGES
        shell: bash
        run: |
          python3 ./scripts/get-dependencies.py --distro msys2 --profile pythonscad-qt6 --output-env "$GITHUB_ENV" --env-var PACBOY_PACKAGES

      - name: Setup MSYS2 Environment
        uses: msys2/setup-msys2@v2
        id: msys2
        with:
          msystem: UCRT64
          update: true
          install: libxml2
          # Add nsis for CPack installer generation
          pacboy: ${{ env.PACBOY_PACKAGES }} nsis:p

      - name: Detect Python version
        id: detect-python
        run: |
          PYTHON_VERSION=$(python --version | cut -d' ' -f2 | cut -d'.' -f1,2)
          echo "Python version detected: $PYTHON_VERSION"
          echo "PYTHON_VERSION=$PYTHON_VERSION" >> $GITHUB_ENV

          PYTHON_FULL_VERSION=$(python --version | cut -d' ' -f2)
          echo "Full Python version: $PYTHON_FULL_VERSION"
          echo "PYTHON_FULL_VERSION=$PYTHON_FULL_VERSION" >> $GITHUB_ENV

      - name: Install Mesa
        uses: ssciwr/setup-mesa-dist-win@v2
        with:
          version: '22.1.7'
          build-type: 'release-mingw'

      - name: Build PythonSCAD
        run: |
          mkdir build && cd build
          cmake .. -G"Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DEXPERIMENTAL=ON \
            -DSNAPSHOT=ON \
            -DUSE_QT6=ON \
            -DENABLE_PYTHON=ON \
            -DENABLE_LIBFIVE=ON \
            -DENABLE_TESTS=OFF \
            -DPACKAGE_ARCH=windows-x86-64
          cmake --build . -j4

      - name: Install to staging directory
        run: |
          cd build
          cmake --install . --prefix=staging

      - name: List installed files
        run: |
          cd build/staging
          echo "=== Root files ==="
          ls -lh *.dll *.conf 2>/dev/null | head -30 || echo "No root DLLs/conf found"
          echo "Total root DLLs: $(ls -1 *.dll 2>/dev/null | wc -l)"
          echo ""
          echo "=== qt.conf contents ==="
          cat qt.conf 2>/dev/null || echo "No qt.conf"
          echo ""
          echo "=== Qt Platform Plugins ==="
          ls -lh platforms/ 2>/dev/null || echo "No platforms/ directory"
          echo ""
          echo "=== Qt Style Plugins ==="
          ls -lh styles/ 2>/dev/null || echo "No styles/ directory"
          echo ""
          echo "=== Qt Image Format Plugins ==="
          ls -lh imageformats/ 2>/dev/null || echo "No imageformats/ directory"
          echo ""
          echo "=== Qt Icon Engine Plugins ==="
          ls -lh iconengines/ 2>/dev/null || echo "No iconengines/ directory"

      - name: Package with CPack
        id: cpack
        run: |
          cd build
          cpack -G ZIP
          cpack -G NSIS

          # List generated packages
          echo "Generated packages:"
          ls -la *.zip *.exe

      - name: Sanity test - verify executable runs
        run: |
          cd build/staging
          echo "Testing pythonscad --info..."
          ./pythonscad.exe --info
          echo "Sanity test passed!"

      - name: Prepare artifacts
        id: artifacts
        run: |
          mkdir -p artifacts

          # Copy ZIP files
          for f in build/*.zip; do
            if [ -f "$f" ] && [[ ! "$f" == *"-Installer.zip" ]]; then
              cp -v "$f" "artifacts/"
            fi
          done

          # Copy NSIS installer
          for f in build/*-Installer.exe; do
            if [ -f "$f" ]; then
              cp -v "$f" "artifacts/"
            fi
          done

          echo "Artifacts prepared:"
          ls -lh artifacts/

          # Set outputs using relative paths
          ZIP_FILE=$(ls artifacts/*.zip 2>/dev/null | head -1 || echo "")
          EXE_FILE=$(ls artifacts/*-Installer.exe 2>/dev/null | head -1 || echo "")

          if [ -n "$ZIP_FILE" ]; then
            echo "zip_path=$ZIP_FILE" >> $GITHUB_OUTPUT
            echo "zip_name=$(basename "$ZIP_FILE" .zip)" >> $GITHUB_OUTPUT
          fi

          if [ -n "$EXE_FILE" ]; then
            echo "exe_path=$EXE_FILE" >> $GITHUB_OUTPUT
            echo "exe_name=$(basename "$EXE_FILE" .exe)" >> $GITHUB_OUTPUT
          fi

      - name: Upload ZIP package
        if: steps.artifacts.outputs.zip_path != ''
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.artifacts.outputs.zip_name }}
          path: ${{ steps.artifacts.outputs.zip_path }}
          retention-days: 30

      - name: Upload NSIS installer
        if: steps.artifacts.outputs.exe_path != ''
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.artifacts.outputs.exe_name }}
          path: ${{ steps.artifacts.outputs.exe_path }}
          retention-days: 30

      - name: Upload artifacts to release
        if: github.event_name == 'release' || github.event.inputs.upload_to_release != ''
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*.zip
            artifacts/*.exe
          tag_name: ${{ github.event.release.tag_name || github.event.inputs.upload_to_release }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
