name: Build Debian packages

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Release tag to upload to (leave empty for test build)'
        required: false
        default: ''
      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        required: false
        default: false

concurrency:
  group: publish-apt-repo
  cancel-in-progress: false

jobs:
  prepare-matrix:
    name: Prepare build matrix from supported distributions
    runs-on: ubuntu-24.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate and prepare matrix
        id: set-matrix
        run: |
          # Validate JSON syntax
          python3 -c "import json; json.load(open('supported-distributions.json'))"

          # Extract matrix for Debian/Ubuntu only, expand to distro x arch combinations
          python3 - <<'EOF'
          from datetime import datetime
          import json
          import os

          with open('supported-distributions.json') as f:
            config = json.load(f)

          today = datetime.utcnow().strftime('%Y-%m')
          matrix_include = []

          for dist in config['distributions']:
            if dist['family'] not in ['debian', 'ubuntu']:
              continue

            if dist.get('eol_date') and dist['eol_date'] < today:
              continue

            for arch in dist['architectures']:
              matrix_include.append({
                'distro': dist['codename'],
                'distro_name': dist['name'],
                'distro_version': dist['version'],
                'family': dist['family'],
                'arch': arch,
                'runner': dist['runner'] if dist['runner'] else 'ubuntu-24.04',
                'docker_image': dist['docker_image'],
                'qemu': arch == 'arm64'
              })

          matrix = {
            'include': matrix_include
          }

          with open(os.environ['GITHUB_OUTPUT'], 'a') as output_file:
            output_file.write(f"matrix={json.dumps(matrix)}\n")
          EOF

  build-debian:
    name: Build .deb (${{ matrix.family }} / ${{ matrix.distro }} / ${{ matrix.arch }})
    needs: prepare-matrix
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    container: ${{ matrix.docker_image || null }}

    steps:
      - name: Ensure git is available and configure
        if: matrix.docker_image
        run: |
          apt-get update
          apt-get install -y git ca-certificates
          git config --global --add safe.directory '*'

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Fetch tags for version detection
        run: |
          git fetch --unshallow --tags 2>/dev/null || git fetch --tags
          git describe --tags --always --dirty

      - name: Setup (detached) tmate session if enabled
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 5
        with:
          detached: true
          limit-access-to-actor: true

      - name: Set up QEMU for ARM64
        if: matrix.qemu && !matrix.docker_image
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Install build dependencies (native runner)
        if: '!matrix.docker_image'
        env:
          DEBIAN_FRONTEND: noninteractive
          TZ: Etc/UTC
        run: |
          sudo apt-get update

          # Determine Qt profile based on distribution version
          # Older distros (Ubuntu 22.04, Debian 11) use Qt5, newer use Qt6
          if [ "${{ matrix.distro }}" = "jammy" ] || [ "${{ matrix.distro }}" = "bullseye" ]; then
            QT_PROFILE="pythonscad-qt5"
          else
            QT_PROFILE="pythonscad-qt6"
          fi
          echo "Using profile: $QT_PROFILE for ${{ matrix.distro }}"

          # Install base dependencies using uni-get-dependencies
          sudo ./scripts/uni-get-dependencies.py --yes --profile "$QT_PROFILE"
          # Install Debian packaging tools
          sudo apt-get install -y \
            debhelper \
            devscripts \
            lintian \
            dpkg-dev \
            fakeroot
          # Install Build-Depends from debian/control
          sudo apt-get install -y libboost-all-dev

      - name: Install build dependencies (Docker container)
        if: matrix.docker_image
        env:
          DEBIAN_FRONTEND: noninteractive
          TZ: Etc/UTC
        run: |
          apt-get update
          # Install git and Python first (needed for uni-get-dependencies)
          apt-get install -y git python3

          # Determine Qt profile based on distribution version
          # Older distros (Ubuntu 22.04, Debian 11) use Qt5, newer use Qt6
          if [ "${{ matrix.distro }}" = "jammy" ] || [ "${{ matrix.distro }}" = "bullseye" ]; then
            QT_PROFILE="pythonscad-qt5"
          else
            QT_PROFILE="pythonscad-qt6"
          fi
          echo "Using profile: $QT_PROFILE for ${{ matrix.distro }}"

          # Install base dependencies using uni-get-dependencies (running as root, no sudo needed)
          ./scripts/uni-get-dependencies.py --yes --profile "$QT_PROFILE"
          # Install Debian packaging tools
          apt-get install -y \
            debhelper \
            devscripts \
            lintian \
            dpkg-dev \
            fakeroot
          # Install Build-Depends from debian/control
          apt-get install -y libboost-all-dev

      - name: Import GPG signing key
        if: github.event_name == 'release' || github.event.inputs.upload_to_release != ''
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          which gpg || (apt-get update && apt-get install -y gnupg)
          echo "${{ secrets.DEB_SIGNING_KEY }}" | gpg --batch --import
          gpg --list-secret-keys

      - name: Build Debian package
        env:
          OUTPUT_DIR: /tmp/debs
          DEBIAN_DISTRO: ${{ matrix.distro }}
          # Set Qt version for older distros
          USE_QT6: ${{ (matrix.distro == 'jammy' || matrix.distro == 'bullseye') && 'OFF' || 'ON' }}
        run: |
          mkdir -p "$OUTPUT_DIR"
          chmod +x ./scripts/build-debian-package.sh
          ./scripts/build-debian-package.sh

      - name: Get version for release upload
        id: version
        run: |
          VERSION=$(cat VERSION.txt | tr -d '\n' | tr -d '\r')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Rename package for GitHub Release (distro + arch)
        run: |
          DEB_FILE=$(ls /tmp/debs/pythonscad_*.deb | head -1)
          if [ -z "$DEB_FILE" ]; then
            echo "Error: No .deb file found"
            exit 1
          fi

          VERSION="${{ steps.version.outputs.version }}"
          NEW_NAME="pythonscad_${VERSION}-1_${{ matrix.distro }}_${{ matrix.arch }}.deb"
          mv "$DEB_FILE" "/tmp/debs/$NEW_NAME"
          ls -lh /tmp/debs/

      - name: Test package installation (amd64 only)
        if: matrix.arch == 'amd64' && !matrix.docker_image
        run: |
          # Try to install the package to verify it works
          sudo dpkg -i /tmp/debs/pythonscad_*.deb || true
          sudo apt-get install -f -y

          # Verify binary exists and shows version
          which pythonscad
          pythonscad --version || echo "Version check skipped (may require display)"

          # Verify library dependencies
          ldd /usr/bin/pythonscad | head -20

      - name: Upload build log as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.distro }}-${{ matrix.arch }}
          path: /tmp/debs/*.log.txt
          retention-days: 7

      - name: Upload to GitHub Release
        if: github.event_name == 'release' || github.event.inputs.upload_to_release != ''
        uses: softprops/action-gh-release@v2
        with:
          files: /tmp/debs/pythonscad_*.deb
          tag_name: ${{ github.event.release.tag_name || github.event.inputs.upload_to_release }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-apt-repo:
    name: Publish APT repository to SFTP
    needs: build-debian
    runs-on: ubuntu-24.04
    if: github.event_name == 'release' || github.event.inputs.upload_to_release != ''

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4

      - name: Download packages from GitHub Release
        run: |
          mkdir -p /tmp/debs
          cd /tmp/debs

          # Determine release tag
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="${{ github.event.inputs.upload_to_release }}"
          fi

          echo "Downloading packages from release: $TAG"

          # Use GitHub CLI to download all .deb files from release
          gh release download "$TAG" \
            -R "${{ github.repository }}" \
            -p "pythonscad_*_*.deb" \
            --dir /tmp/debs

          ls -lh /tmp/debs/
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Import GPG signing key
        run: |
          echo "${{ secrets.DEB_SIGNING_KEY }}" | gpg --batch --import
          gpg --list-secret-keys

      - name: Setup SSH key for SFTP
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.REPO_SFTP_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.REPO_SFTP_HOST }} >> ~/.ssh/known_hosts

      - name: Download existing repository from SFTP
        run: |
          # Download existing repo to preserve old versions
          mkdir -p /tmp/apt-repo-existing
          mkdir -p /tmp/apt-repo

          # Download existing repo (ignore errors if doesn't exist yet)
          rsync -avz \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ${{ secrets.REPO_SFTP_USER }}@${{ secrets.REPO_SFTP_HOST }}:${{ secrets.REPO_SFTP_BASE_PATH }}/apt/ \
            /tmp/apt-repo-existing/ || echo "No existing repository found (first run)"

          # Copy existing packages to new repo location
          if [ -d /tmp/apt-repo-existing/pool ]; then
            mkdir -p /tmp/apt-repo/pool/main/p/pythonscad
            cp /tmp/apt-repo-existing/pool/main/p/pythonscad/*.deb /tmp/apt-repo/pool/main/p/pythonscad/ 2>/dev/null || true
          fi

      - name: Build APT repository structure
        env:
          REPO_DIR: /tmp/apt-repo
          GPG_KEY: ${{ secrets.GPG_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          KEEP_VERSIONS: ${{ vars.REPO_KEEP_VERSIONS || '3' }}
          REPO_BASE_URL: ${{ secrets.REPO_BASE_URL }}
        run: |
          # Repository now contains both old and new packages
          # update-apt-repo.sh will clean up old versions based on KEEP_VERSIONS
          chmod +x ./scripts/update-apt-repo.sh
          ./scripts/update-apt-repo.sh /tmp/debs

      - name: Upload to SFTP server
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            /tmp/apt-repo/ \
            ${{ secrets.REPO_SFTP_USER }}@${{ secrets.REPO_SFTP_HOST }}:${{ secrets.REPO_SFTP_BASE_PATH }}/apt/

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
