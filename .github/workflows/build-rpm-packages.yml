name: Build RPM packages

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Release tag to upload to (leave empty for test build)'
        required: false
        default: ''

jobs:
  build-rpm:
    name: Build .rpm (${{ matrix.distro }} ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Fedora 40 (amd64)
          - distro: fedora
            version: '40'
            arch: amd64
            runner: ubuntu-24.04
            container: fedora:40
          # Fedora 40 (arm64)
          - distro: fedora
            version: '40'
            arch: arm64
            runner: ubuntu-24.04
            container: fedora:40
          # Fedora 41 (amd64)
          - distro: fedora
            version: '41'
            arch: amd64
            runner: ubuntu-24.04
            container: fedora:41
          # RHEL 9 compatible (amd64)
          - distro: el
            version: '9'
            arch: amd64
            runner: ubuntu-24.04
            container: rockylinux:9

    container:
      image: ${{ matrix.container }}

    steps:
      - name: Install git and basic tools
        run: |
          if [ -f /etc/fedora-release ]; then
            dnf install -y git tar gzip
          else
            dnf install -y git tar gzip epel-release
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Fetch tags for version detection
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git fetch --unshallow --tags 2>/dev/null || git fetch --tags
          git describe --tags --always --dirty || echo "No tags found"

      - name: Set up QEMU for ARM64
        if: matrix.arch == 'arm64'
        run: |
          dnf install -y qemu-user-static

      - name: Install build dependencies
        run: |
          # Install RPM build tools
          if [ -f /etc/fedora-release ]; then
            dnf install -y \
              rpm-build \
              rpmdevtools \
              rpmlint \
              dnf-plugins-core
          else
            # RHEL/Rocky/Alma
            dnf install -y \
              rpm-build \
              rpmdevtools \
              rpmlint \
              dnf-plugins-core \
              'dnf-command(config-manager)'
            dnf config-manager --set-enabled crb || true
          fi

          # Install build dependencies from spec file
          dnf builddep -y pythonscad.spec

      - name: Build RPM package
        env:
          OUTPUT_DIR: /tmp/rpms
          FEDORA_RELEASE: ${{ matrix.version }}
        run: |
          # Set architecture for cross-compilation if needed
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            export ARCH=aarch64
          fi

          ./scripts/build-rpm-package.sh

      - name: Test package installation (amd64 only)
        if: matrix.arch == 'amd64'
        run: |
          # Install the package to verify it works
          dnf install -y /tmp/rpms/pythonscad-*.rpm

          # Verify binary exists and shows version
          which pythonscad
          pythonscad --version || echo "Version check skipped (may require display)"

          # Verify library dependencies
          ldd /usr/bin/pythonscad | head -20 || true

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pythonscad-${{ matrix.distro }}${{ matrix.version }}-${{ matrix.arch }}-rpm
          path: /tmp/rpms/*
          retention-days: 30

      - name: Upload to GitHub Release
        if: github.event_name == 'release' || github.event.inputs.upload_to_release != ''
        uses: softprops/action-gh-release@v2
        with:
          files: /tmp/rpms/*
          tag_name: ${{ github.event.release.tag_name || github.event.inputs.upload_to_release }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-yum-repo:
    name: Update YUM repository
    needs: build-rpm
    runs-on: ubuntu-24.04
    if: github.event_name == 'release' || github.event.inputs.upload_to_release != ''

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Checkout yum-repo branch
        uses: actions/checkout@v4
        with:
          ref: yum-repo
          path: yum-repo
          fetch-depth: 0

      - name: Download all RPM artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/rpms
          pattern: pythonscad-*-rpm

      - name: Merge packages
        run: |
          mkdir -p /tmp/rpms/all
          find /tmp/rpms -name "*.rpm" -exec cp {} /tmp/rpms/all/ \;
          ls -lh /tmp/rpms/all/

      - name: Install createrepo
        run: |
          sudo apt-get update
          sudo apt-get install -y createrepo-c

      - name: Import GPG signing key
        run: |
          echo "${{ secrets.DEB_SIGNING_KEY }}" | gpg --batch --import
          gpg --list-secret-keys

      - name: Update YUM repository
        env:
          REPO_DIR: yum-repo
          GPG_KEY: ${{ secrets.GPG_KEY_ID }}
        run: |
          cp main-repo/scripts/update-yum-repo.sh /tmp/
          chmod +x /tmp/update-yum-repo.sh
          cd yum-repo
          /tmp/update-yum-repo.sh /tmp/rpms/all

      - name: Commit and push repository updates
        run: |
          cd yum-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .

          # Get version from main repo
          VERSION=$(cat ../main-repo/VERSION.txt 2>/dev/null || echo "unknown")

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update repository with version ${VERSION}"
            git push origin yum-repo
          fi

  create-yum-repo-branch:
    name: Create yum-repo branch if needed
    runs-on: ubuntu-24.04
    if: github.event_name == 'release' || github.event.inputs.upload_to_release != ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if yum-repo branch exists
        id: check_branch
        run: |
          if git ls-remote --heads origin yum-repo | grep -q yum-repo; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create yum-repo branch
        if: steps.check_branch.outputs.exists == 'false'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Create orphan branch
          git checkout --orphan yum-repo
          git rm -rf .

          # Create initial README
          cat > README.md <<'EOF'
          # PythonSCAD YUM Repository

          This branch contains the YUM/DNF repository for PythonSCAD RPM packages.

          Visit the repository at: https://pythonscad.github.io/pythonscad

          ## Structure

          - `repodata/` - Repository metadata
          - `packages/` - RPM packages organized by distribution
          - `pythonscad.repo` - Repository configuration file
          - `RPM-GPG-KEY-pythonscad` - Public GPG key
          - `index.html` - Repository homepage
          EOF

          git add README.md
          git commit -m "Initialize yum-repo branch"
          git push origin yum-repo
