
Read openscad.cc, lines 615 to 640

openscad.cc+2-2
Now let's build and see if it compiles:


cd /d/repositories/openscad-6224/build && cmake --build . --config Release -j4 2>&1 | tail -80
I see the issue - Location needs a std::shared_ptr<fs::path>fs::path not a string. Let me check the AST.h for Location:

Read AST.h

Summarized conversation history

I see. I need to use Location::NONE as the default and create a proper Location with fs::path. Let me check the current state of ParameterWidget.cc and fix it:

Read ParameterWidget.cc, lines 148 to 185

Summarized conversation history

ParameterWidget.cc+4-3
Summarized conversation history

Now rebuild:


cd /d/repositories/openscad-6224/build && cmake --build . --config Release -j4 2>&1 | tail -60
Summarized conversation history

The build succeeded! Now let's test with the bad JSON files that were created earlier. First, let me check if they exist:


ls -la /d/repositories/openscad-6224/tests/bad-json/
Let me look at the bad JSON file to understand the expected error:

Read customizer-all-bad.json

Good - there's a missing brace and malformed JSON. Now let's run OpenSCAD with this file to see if our error is reported:


cd /d/repositories/openscad-6224/build && ./openscad.exe -o /tmp/out.csg "/d/repositories/openscad-6224/tests/bad-json/customizer-all-bad.scad" 2>&1
The command-line version ran but didn't show the JSON error. Let me check the code in openscad.cc - it looks like we changed it, but the error might still not be output. Let me look at how LOG() works there:

Read openscad.cc, lines 620 to 650

I see - in the command-line version, we read the error info but don't report it! Let me fix that:

openscad.cc+5-0
Now check if we need the Location include:

Good, Location is already used in the file. Let me rebuild and test:


cd /d/repositories/openscad-6224/build && cmake --build . --config Release -j4 2>&1 | tail -20
I see - the Location constructor order is different. Let me look at the correct signature:

Read AST.h, lines 1 to 40

I see, it's (firstLine, firstCol, lastLine, lastCol, path) - lines/columns first, then path. Let me fix both usages:

Read openscad.cc, lines 625 to 640

openscad.cc+4-4
Now also fix ParameterWidget.cc with the correct Location constructor order:

Read ParameterWidget.cc, lines 155 to 180

That's already correct! Let's rebuild:


cd /d/repositories/openscad-6224/build && cmake --build . --config Release -j4 2>&1 | tail -20
Build succeeded. Now let's test the command-line version:


cd /d/repositories/openscad-6224/build && ./openscad.exe -o /tmp/out.csg -p "/d/repositories/openscad-6224/tests/bad-json/customizer-all-bad.json" -P "New set 1" "/d/repositories/openscad-6224/tests/bad-json/customizer-all-bad.scad" 2>&1
Excellent! Now we see two error messages:

ERROR: Cannot open Parameter Set 'D:/repositories/openscad-6224/tests/bad-json/customizer-all-bad.json': <unspecified file>(7): expected '}' or ','
ERROR: expected '}' or ',' in file ../tests/bad-json/customizer-all-bad.json, line 7
The second one looks like it's coming from the original LOG() call in ParameterSet.cc. Let me clean that up since we now have our own error reporting:

Read ParameterSet.cc, lines 76 to 76

Read ParameterSet.cc, lines 50 to 76

Read ParameterSet.cc, lines 20 to 50

I see. The LOG() call at line 30 is the old one that's still there. Since we're now storing the error info and it will be reported by the caller, we should remove this LOG() call. However, this would change behavior for calling code that doesn't check the error. Let me think about this...

Actually, looking at the output, we have:

Our new error from openscad.cc using our structured error (line 7, message about expected '}' or ',')
The old LOG() from ParameterSet.cc that includes the full e.what()
But e.what() includes <unspecified file>(7): prefix which isn't very clean. Our new one is cleaner because we're using the actual filename. However, it's still showing <unspecified file> in the message, because the boost message includes it. Let me look at what e.message() returns vs e.what():

The issue is that e.message() is the message part without file/line, while e.what() is the formatted string including file/line but with <unspecified file> when reading from a stream.

Let's remove the old LOG() call since we now properly capture the error info for the caller to report:

ParameterSet.cc+2-1
Now rebuild and test again:


cd /d/repositories/openscad-6224/build && cmake --build . --config Release -j4 2>&1 | tail -10

cd /d/repositories/openscad-6224/build && ./openscad.exe -o /tmp/out.csg -p "/d/repositories/openscad-6224/tests/bad-json/customizer-all-bad.json" -P "New set 1" "/d/repositories/openscad-6224/tests/bad-json/customizer-all-bad.scad" 2>&1
Now we get a single, clean error message:

This is exactly what we want - a clear error message with the filename and line number.

Now let's also test the GUI version. Let me start OpenSCAD to test opening the bad JSON in the GUI:


cd /d/repositories/openscad-6224/build && ./openscad.exe "/d/repositories/openscad-6224/tests/bad-json/customizer-all-bad.scad" &
The GUI is launched. Let me create a summary of all the changes made to fix this issue: